<html>
    <head>
        <meta charset="utf-8"/>

        <!-- Third-party-->
        <script src="node_modules/pixi.js/bin/pixi.min.js"></script>
        <script src="node_modules/pathfinding/visual/lib/pathfinding-browser.min.js"></script>


        <!--Debugging -->
        <script src="js/game/Helpers/Enums.js"></script>
        <script src="js/game/Helpers/Geometry.js"></script>
        <script src="js/game/Actors/Sprites/Sprite.js"></script>
        <script src="js/game/Actors/Sprites/SpriteSet.js"></script>
        <script src="js/game/Actors/Sprites/WorldItems/ChestSprites.js"></script>
        <script src="js/game/Actors/Sprites/Characters/PlayerSprites.js"></script>
        <script src="js/game/Actors/Sprites/Characters/ChaserSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/FloorSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/WallSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/BookshelfSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/PillarSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/Special/OutOfBoundsSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/Special/StairsDownSprites.js"></script>
        <script src="js/game/Actors/Sprites/Environment/Special/StairsUpSprites.js"></script>
        <script src="js/game/Actors/Behaviour/Command.js"></script>
        <script src="js/game/Actors/Behaviour/Action.js"></script>
        <script src="js/game/Actors/Behaviour/Commands/MoveTo.js"></script>
        <script src="js/game/Actors/Behaviour/Actions/Move.js"></script>
        <script src="js/game/Actors/Base/Actor.js"></script>
        <script src="js/game/Actors/Inventory/Base/InventoryItem.js"></script>
        <script src="js/game/Actors/Inventory/Potion.js"></script>
        <script src="js/game/Actors/WorldItems/Base/WorldItem.js"></script>
        <script src="js/game/Actors/WorldItems/Chest.js"></script>
        <script src="js/game/Renderers/Renderer.js"></script>
        <script src="js/game/Actors/Environment/Wall.js"></script>
        <script src="js/game/Actors/Environment/Floor.js"></script>
        <script src="js/game/Actors/Environment/Bookshelf.js"></script>
        <script src="js/game/Actors/Environment/Pillar.js"></script>
        <script src="js/game/Actors/Environment/Special/StairsDown.js"></script>
        <script src="js/game/Actors/Environment/Special/StairsUp.js"></script>
        <script src="js/game/Actors/Environment/Special/OutOfBounds.js"></script>
        <script src="js/game/Actors/Character/Player.js"></script>
        <script src="js/game/Actors/Character/Chaser.js"></script>
        <script src="js/game/Layer.js"></script>
        <script src="js/game/World.js"></script>
        <script src="js/game/Room.js"></script>
        <script src="js/game/Point.js"></script>
        <script src="js/game/Helpers/Rendering.js"></script>
        <script src="js/game/Helpers/Extensions.js"></script>
        <script src="js/game/Helpers/Random.js"></script>
        <script src="js/game/Helpers/Numbers.js"></script>
        <script src="js/game/Helpers/Movement.js"></script>
        <script src="js/game/Helpers/Generation/GenerationHelpers.js"></script>
        <script src="js/game/Helpers/Generation/WorldDecoratorHelpers.js"></script>
        <script src="js/game/Helpers/Generation/WorldDecorator.js"></script>
        <script src="js/game/Renderers/TextRenderer.js"></script>
        <script src="js/game/Renderers/PixiRenderer.js"></script>
        <script src="js/game/Helpers/Generation/WorldGenerator.js"></script>
        <script src="js/game/Menu/Menu.js"></script>
        <script src="js/game/Menu/Menus/MainMenu.js"></script>
        <script src="js/game/Game.js"></script>

        <!-- Built -->
        <!--<script src="js/game.min.js"></script>-->

        <script type="text/javascript">

            // FOR DEVELOPMENT
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            };


            // on DOM load
            document.addEventListener("DOMContentLoaded", function(event) {
                // Load resources
                PIXI.loader
                           .add('terrainAtlas','art/rogueliketiles.json')
                           .add('characterAtlas','art/characters_1.json')
                           .add('wallsAtlas','art/walls.json')
                           .load(setupGame);

                // On resources load
                function setupGame(){
                    // Setup resources

                    // Setup game
                    var seed = (new Date).getTime(); // or specify a seed to be used by the entire game

                    // FOR DEVELOPMENT
                    var seedInQS = getUrlParameter('seed');
                    if(seedInQS !== ''){
                      seed = seedInQS;
                    }
                    else{
                      history.pushState({}, '', window.location.href+'?seed='+seed);
                    }

                    // Our area to render to
                    var canvas = document.getElementById('canvas');

                    var renderer = new PixiRenderer(
                      canvas,
                      40, // view width
                      30  // view height
                    );

                    // Prep seed if it's not numeric
                    if(seed.match(/[a-z]/i)){
                      var string = seed;
                      seed = '';
                      for(var i=0; i<string.length; i++){
                        seed+=string.charCodeAt(i);
                      }
                    }

                    // Start the game
                    var game = new Game(renderer, seed);
                    game.setRandomDungeon();
                    game.start();

                    // Bind keys
                    document.onkeydown = keyDown;
                    document.onkeyup = keyUp;
                    var isKeyRepeating = false;
                    var keyRepeatTimer = null;
                    var keyRepeatRate = 25; // In milliseconds
                    function keyUp(e){
                          if(keyRepeatTimer!==null){
                            clearTimeout(keyRepeatTimer);
                            keyRepeatTimer = null;
                          }
                          isKeyRepeating = false;
                    }

                    function keyDown(e){
                          e.preventDefault();
                          if(isKeyRepeating){
                            if(keyRepeatTimer == null){
                              keyRepeatTimer = setTimeout( function( ) {
                                  isKeyRepeating = false;
                                  clearTimeout(keyRepeatTimer);
                                  keyRepeatTimer = null;
                              }, keyRepeatRate);
                            }
                          }
                          else{
                            isKeyRepeating = true;
                            e = e || window.event;
                            game.controlPressed(e.keyCode);
                          }
                    }
                }
            });
        </script>
    </head>
    <body style="background-color:black;">
        <div id="canvas" style="height:100%;width:100%">

        </div>
    </body>
</html>
